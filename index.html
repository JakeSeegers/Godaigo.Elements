<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Godaigo - Hexagon Tile Game</title>
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <!-- CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- ============================================
         LOBBY WRAPPER (shown before game starts)
         ============================================ -->
    <div class="lobby-wrapper" id="lobby-wrapper">
        <h1>Godaigo</h1>

    <!-- Multiplayer Lobby -->
    <div id="multiplayer-lobby" style="background: #222; padding: 30px; border-radius: 10px; margin-bottom: 20px; max-width: 600px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="color: #d9b08c; margin-top: 0;">Multiplayer Lobby</h2>
            <button onclick="resetLobby()"
                    style="padding: 8px 15px; font-size: 14px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">
                üîÑ Reset Lobby
            </button>
        </div>

        <!-- Join Form -->
        <div id="join-form" style="margin-bottom: 20px;">
            <input type="text" id="username-input" placeholder="Enter your username"
                   style="padding: 10px; font-size: 16px; width: 300px; background: #333; color: #eee; border: 2px solid #666; border-radius: 5px;">
            <button id="join-button" onclick="joinLobby()"
                    style="padding: 10px 20px; font-size: 16px; margin-left: 10px;">Join Game</button>
            <div id="join-loading" style="display: none; margin-top: 15px; text-align: center;">
                <div style="display: inline-block; width: 30px; height: 30px; border: 3px solid #666; border-top: 3px solid #d9b08c; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p style="color: #d9b08c; margin-top: 10px;">Joining lobby...</p>
            </div>
        </div>

        <!-- Player List -->
        <div id="player-list" style="background: #333; padding: 20px; border-radius: 5px; margin-bottom: 20px; min-height: 100px;">
            <h3 style="margin-top: 0; color: #d9b08c;">Players in Lobby:</h3>
            <div id="players-container" style="color: #eee;"></div>
        </div>

        <!-- Ready Button (hidden until joined) -->
        <div id="ready-controls" style="display: none; text-align: center;">
            <button id="ready-button" onclick="toggleReady()"
                    style="padding: 15px 40px; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                I'm Ready!
            </button>

            <!-- Host-only Settings & Start Game -->
            <div id="host-settings" style="display: none; margin-top: 20px; background: #333; padding: 15px; border-radius: 5px;">
                <h4 style="color: #d9b08c; margin-top: 0;">Host Settings</h4>

                <div style="margin-bottom: 10px;">
                    <label style="color: #eee; display: block; margin-bottom: 5px;">Turn Time Limit:</label>
                    <select id="timeout-setting" style="padding: 8px; background: #444; color: #eee; border: 1px solid #666; border-radius: 5px;">
                        <option value="0">Disabled</option>
                        <option value="30">30 seconds</option>
                        <option value="60">1 minute</option>
                        <option value="120" selected>2 minutes</option>
                        <option value="180">3 minutes</option>
                        <option value="300">5 minutes</option>
                    </select>
                    <label style="color: #eee; display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                        <input type="checkbox" id="kick-on-timeout" checked>
                        Kick active player when turn timer expires
                    </label>
                    <div style="color: #999; font-size: 12px; margin-top: 6px;">
                        If disabled, expired turns will auto-pass to the next player.
                    </div>
                </div>

                <button id="host-start-button" onclick="hostStartGame()"
                        style="padding: 15px 40px; font-size: 18px; background: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                    Start Game (Host)
                </button>
            </div>

            <p id="lobby-instruction" style="color: #999; margin-top: 10px; font-size: 14px;">
                The host can start the game when 2-5 players have joined
            </p>
        </div>

        <!-- Status -->
        <div id="lobby-status" style="text-align: center; color: #999; margin-top: 15px;"></div>
    </div>

    <!-- Old player selection (hidden, for fallback/testing) -->
    <div id="player-selection" style="display: none; background: #222; padding: 30px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
        <h2 style="color: #d9b08c; margin-top: 0;">Select Number of Players (Local)</h2>
        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <button onclick="startGame(1)" style="padding: 15px 30px; font-size: 18px;">1 Player</button>
            <button onclick="startGame(2)" style="padding: 15px 30px; font-size: 18px;">2 Players</button>
            <button onclick="startGame(3)" style="padding: 15px 30px; font-size: 18px;">3 Players</button>
            <button onclick="startGame(4)" style="padding: 15px 30px; font-size: 18px;">4 Players</button>
            <button onclick="startGame(5)" style="padding: 15px 30px; font-size: 18px;">5 Players</button>
        </div>
        <p style="color: #999; margin-top: 15px; font-size: 14px;">
            1 player = 6 tiles (1 of each type)<br>
            Each additional player adds 6 more tiles in a spiral pattern
        </p>
    </div>
    </div><!-- End lobby-wrapper -->

    <!-- ============================================
         NEW GAME LAYOUT (CSS Grid based)
         ============================================ -->
    <div class="game-layout" id="game-layout">
        <!-- TOP HUD BAR -->
        <div class="hud-bar">
            <div class="hud-section left">
                <button class="hud-toggle-btn" id="toggle-left-panel" title="Toggle resources panel">‚óÄ</button>
                <div class="hud-player">
                    <span class="player-dot" id="hud-player-dot"></span>
                    <span class="hud-player-name" id="hud-player-name">Your Turn</span>
                </div>
            </div>

            <div class="hud-section middle">
                <div class="hud-badges">
                    <span class="hud-badge hand" title="Scrolls in hand">üé¥ <span id="hud-hand-count">0</span>/3</span>
                    <span class="hud-badge active" title="Active scrolls">‚ö° <span id="hud-active-count">0</span>/2</span>
                    <span class="hud-badge common" title="Common area scrolls">üåê <span id="hud-common-count">0</span></span>
                </div>
            </div>

            <div class="hud-section right">
                <div class="hud-ap" title="Action Points">
                    <span class="hud-ap-value" id="hud-ap-value">5</span>
                    <span class="hud-ap-label">AP</span>
                    <span id="hud-void-ap" style="color: #9458f4; margin-left: 4px;"></span>
                </div>
                <div class="hud-timer" id="hud-timer" style="display: none;">
                    <span>‚è±</span>
                    <span id="hud-timer-value">2:00</span>
                </div>
                <button class="hud-toggle-btn" id="toggle-right-panel" title="Toggle opponents panel">‚ñ∂</button>
            </div>
        </div>

        <!-- LEFT PANEL (Resources) -->
        <div class="left-panel" id="left-panel">
            <div class="panel-header">
                <span class="panel-title">Resources</span>
            </div>
            <div class="panel-content">
                <!-- Stone Grid -->
                <div class="stone-grid" id="stone-grid">
                    <div class="stone-card" id="new-earth-deck" data-element="earth">
                        <svg width="36" height="36">
                            <circle cx="18" cy="18" r="14" fill="#69d83a" class="stone-piece"/>
                            <text x="18" y="18" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="14" font-weight="bold">‚ñ≤</text>
                        </svg>
                        <div class="count" id="new-earth-count">0/5</div>
                        <div class="source" id="new-earth-source">20</div>
                    </div>
                    <div class="stone-card" id="new-water-deck" data-element="water">
                        <svg width="36" height="36">
                            <circle cx="18" cy="18" r="14" fill="#5894f4" class="stone-piece"/>
                            <text x="18" y="18" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="14" font-weight="bold">‚óØ</text>
                        </svg>
                        <div class="count" id="new-water-count">0/5</div>
                        <div class="source" id="new-water-source">20</div>
                    </div>
                    <div class="stone-card" id="new-fire-deck" data-element="fire">
                        <svg width="36" height="36">
                            <circle cx="18" cy="18" r="14" fill="#ed1b43" class="stone-piece"/>
                            <text x="18" y="18" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="14" font-weight="bold">‚ô¶</text>
                        </svg>
                        <div class="count" id="new-fire-count">0/5</div>
                        <div class="source" id="new-fire-source">20</div>
                    </div>
                    <div class="stone-card" id="new-wind-deck" data-element="wind">
                        <svg width="36" height="36">
                            <circle cx="18" cy="18" r="14" fill="#ffce00" class="stone-piece"/>
                            <text x="18" y="18" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="14" font-weight="bold">‚âã</text>
                        </svg>
                        <div class="count" id="new-wind-count">0/5</div>
                        <div class="source" id="new-wind-source">20</div>
                    </div>
                    <div class="stone-card" id="new-void-deck" data-element="void">
                        <svg width="36" height="36">
                            <circle cx="18" cy="18" r="14" fill="#9458f4" class="stone-piece"/>
                            <text x="18" y="18" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="14" font-weight="bold">‚ú∫</text>
                        </svg>
                        <div class="count" id="new-void-count">0/5</div>
                        <div class="source" id="new-void-source">20</div>
                    </div>
                </div>

                <!-- Player Tiles Section -->
                <div class="tiles-section">
                    <div class="section-label">Player Tiles (<span id="new-player-tile-count">0</span>)</div>
                    <div id="new-player-tile-deck" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                        <!-- Player tiles will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- BOARD AREA (Center) -->
        <div class="board-area">
            <div class="board-container" id="new-board-container">
                <svg id="boardSvg" width="1000" height="800">
                    <g id="viewport">
                        <circle class="snap-indicator" id="snapIndicator" r="10" cx="0" cy="0"/>
                    </g>
                </svg>
            </div>
            <div id="status">Ready to play</div>
        </div>

        <!-- RIGHT PANEL (Opponents/Players) -->
        <div class="right-panel" id="right-panel">
            <div class="panel-header">
                <span class="panel-title">Players</span>
            </div>
            <div class="panel-content" id="new-opponent-cards">
                <!-- Player cards will be populated dynamically -->
            </div>
        </div>

        <!-- BOTTOM ACTION BAR -->
        <div class="action-bar">
            <div class="action-group">
                <button id="scroll-inventory">üìú Scrolls (<span id="scroll-count">0</span>)</button>
                <button id="cast-spell" class="primary">‚ú® Cast Spell</button>
            </div>

            <div class="action-divider"></div>

            <div class="action-group">
                <button id="undo-move">‚ü≤ Undo</button>
                <button id="tile-move-toggle" title="Enable/disable tile moving">üîì Tiles</button>
            </div>

            <div class="action-divider"></div>

            <div class="action-group">
                <button id="end-turn" class="primary" style="display: none;">End Turn</button>
                <button id="leave-game" class="danger" style="display: none;">Leave</button>
            </div>
        </div>
    </div>

    <!-- OLD GAME CONTAINER (hidden, kept for JS compatibility) -->
    <div class="game-container inventory-collapsed" style="display: none !important;">
        <div class="deck-panel">
            <div class="inventory-header">
                <div class="inventory-title">üéí Inventory</div>
                <button id="inventory-close" class="inventory-close-btn" aria-label="Close inventory">‚úï</button>
            </div>

            <h3 id="tile-deck-header">Tile Deck (<span id="deck-count">0/24</span>)</h3>
            <div class="tile-deck" id="tile-deck-container">
                <svg width="150" height="150" class="deck-tile" id="deckTile"></svg>
            </div>

            <h3 id="player-tiles-header" style="margin-top: 30px;">Player Tiles (<span id="player-tile-count">0</span>)</h3>
            <div class="tile-deck" id="player-tile-deck">
                <!-- Player tiles will be added here dynamically -->
            </div>

            <h3 style="margin-top: 30px;">Player Pool</h3>
            <div class="stone-deck">
                <div class="stone-deck-item" id="earth-deck">
                    <svg width="40" height="40">
                        <circle cx="20" cy="20" r="12" fill="#69d83a" class="stone-piece"/>
                        <text x="20" y="20" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="14" font-weight="bold">‚ñ≤</text>
                    </svg>
                    <div class="stone-count" id="earth-count">0/5</div>
                    <div class="source-count" id="earth-source">20/25</div>
                </div>
                <div class="stone-deck-item" id="water-deck">
                    <svg width="40" height="40">
                        <circle cx="20" cy="20" r="12" fill="#5894f4" class="stone-piece"/>
                        <text x="20" y="20" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="14" font-weight="bold">‚óØ</text>
                    </svg>
                    <div class="stone-count" id="water-count">0/5</div>
                    <div class="source-count" id="water-source">20/25</div>
                </div>
                <div class="stone-deck-item" id="fire-deck">
                    <svg width="40" height="40">
                        <circle cx="20" cy="20" r="12" fill="#ed1b43" class="stone-piece"/>
                        <text x="20" y="20" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="14" font-weight="bold">‚ô¶</text>
                    </svg>
                    <div class="stone-count" id="fire-count">0/5</div>
                    <div class="source-count" id="fire-source">20/25</div>
                </div>
                <div class="stone-deck-item" id="wind-deck">
                    <svg width="40" height="40">
                        <circle cx="20" cy="20" r="12" fill="#ffce00" class="stone-piece"/>
                        <text x="20" y="20" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="14" font-weight="bold">‚âã</text>
                    </svg>
                    <div class="stone-count" id="wind-count">0/5</div>
                    <div class="source-count" id="wind-source">20/25</div>
                </div>
                <div class="stone-deck-item" id="void-deck">
                    <svg width="40" height="40">
                        <circle cx="20" cy="20" r="12" fill="#9458f4" class="stone-piece"/>
                        <text x="20" y="20" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="14" font-weight="bold">‚ú∫</text>
                    </svg>
                    <div class="stone-count" id="void-count">0/5</div>
                    <div class="source-count" id="void-source">20/25</div>
                </div>
            </div>
        </div>

        <div style="display: flex; flex-direction: column;">
            <div class="board-container">
                <svg id="boardSvg" width="1000" height="800">
                    <g id="viewport">
                        <circle class="snap-indicator" id="snapIndicator" r="10" cx="0" cy="0"/>
                    </g>
                </svg>
            </div>

            <div class="controls">
                <div class="player-info">
                    <div class="action-points">
                        AP: <span id="ap-count">5</span>/5
                        <span id="void-ap-display" style="color: #9458f4; margin-left: 10px;"></span>
                        <span id="inactivity-timer" style="display: none; margin-left: 15px; padding: 5px 10px; border-radius: 5px; font-weight: bold;"></span>
                    </div>
                    <button id="inventory-toggle" title="Show/hide inventory">üéí Inventory</button>
                    <button id="end-turn" style="display: none;">End Turn</button>
                    <button id="undo-move">Undo Move</button>
                    <button id="tile-move-toggle" title="Enable/disable tile moving">üîì Move Tiles</button>
                    <button id="scroll-inventory">üìú Scrolls (<span id="scroll-count">0</span>)</button>
                    <button id="cast-spell">‚ú® Cast Spell (2 AP)</button>
                                        <button id="leave-game" style="display: none; background: #f44336;">Leave Game</button>
                </div>

                <div id="status">Drag tiles from the deck to build your board. Drag stones onto hexes.<br>
                <small style="color: #999;">All stones: 1 AP baseline | üî• Fire destroys adjacent non-void | üíß Water (2 AP) chains abilities | üå™Ô∏è Wind free movement | üóª Earth blocks | ‚ú® Void nullifies</small></div>
            </div>
        </div>

        <!-- Opponent Panel (visible in multiplayer) -->
        <div class="opponent-panel" id="opponent-panel">
            <h3>üë• Opponents</h3>
            <div id="opponent-cards">
                <!-- Opponent cards will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Mobile Deck UI (hidden on desktop) -->
    <div class="mobile-deck-container">
        <div class="mobile-tab-buttons">
            <button class="mobile-tab-btn active" data-tab="tiles">
                Tiles
            </button>
            <button class="mobile-tab-btn" data-tab="stones">
                Stones
            </button>
        </div>

        <div class="mobile-deck-panel" id="mobile-tiles-panel">
            <h3>Tiles (<span id="mobile-tile-count">0</span>)</h3>
            <div class="mobile-tile-grid" id="mobile-tile-grid">
                <!-- Tiles will be added here dynamically -->
            </div>
        </div>

        <div class="mobile-deck-panel" id="mobile-stones-panel">
            <h3>Stones</h3>
            <div class="mobile-stone-grid" id="mobile-stone-grid">
                <!-- Stones will be added here dynamically -->
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <!-- Scroll System (load before main.js) -->
    <script src="js/scrolls/scroll-definitions.js" charset="UTF-8"></script>
    <script src="js/scrolls/response-window.js" charset="UTF-8"></script>
    <script src="js/main.js" charset="UTF-8"></script>
</body>
</html>
